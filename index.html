<head>
	<meta name="viewport" content="width=device-width">
</head>

<body>
	<style>
		html,
		body {
			height: 100%;
			padding: 0;
			margin: 0;
		}

		@media (min-width: 576px) {
			.center-webchat [data-cognigy-webchat] {
				position: fixed;

				left: 50%;
				top: 50%;

				width: 480px;
				height: 640px;

				margin-left: -240px;
				margin-top: -320px;
			}

			.center-webchat [data-cognigy-webchat-toggle] {
				display: none !important;
			}

			[data-header-close-button] {
				display: none !important;
			}
		}
	</style>
	<script src="../build/webchat.legacy.js"></script>
	<script>
		function fetchConfig(url, callback) {
			var request = new XMLHttpRequest();
			request.open('GET', url, true);

			request.onload = function () {
				if (request.status >= 200 && request.status < 400) {
					var data = JSON.parse(request.responseText);

					callback(null, data)
				} else {
					callback('Could not parse json')
				}
			};

			request.onerror = function () {
				callback('Request failed')
			};

			request.send();
		}

		function loadScript(src, callback) {
			var script = document.createElement('script');
			script.setAttribute('src', src);

			function handleLoad() {
				callback(null);
			}

			script.onload = handleLoad;

			document.body.appendChild(script);
		}

		function loadScripts(urls, callback) {
			if (!urls || urls.length === 0)
				return callback(null);

			var loaded = 0;

			function onLoad() {
				loaded++;

				if (loaded === urls.length)
					callback(null)
			}

			urls.forEach(function (url) {
				loadScript(url, onLoad);
			});
		}

		var urlParameters = {}
		window.location.search.slice(1).split("&")
			.map(function (parameter) {
				var key = parameter.substr(0, parameter.indexOf("="));
				var value = parameter.substr(parameter.indexOf("=") + 1);
				urlParameters[key] = decodeURI(value);
			});

		var options = {
			channel: 'admin-webchat',
			settings: {
				useSessionStorage: true,
				enableUnreadMessageTitleIndicator: true,
				enableUnreadMessageSound: true
			}
		};

		/** Get the user id from url parameters **/
		if (urlParameters.user)
			options.userId = urlParameters.user;

		/** Get the session id from url parameters **/
		if (urlParameters.sessionId)
			options.sessionId = urlParameters.sessionId;


		/**
		 * If the forceWebsockets environment variable
		 * is set to either "true" or "false",
		 * then we override the setting. Otherwise
		 * we use the default setting which will
		 * e.g. set forceWebsockets to true if the
		 * browser is IE11
		 */
		const forceWebsockets = "";

		if (forceWebsockets === "true") {
			options.forceWebsockets = true;
		} else if (forceWebsockets === "false") {
			options.forceWebsockets = false;
		}

		/** Get the endpoint base URL from the env */
		var endpointBaseUrl = "https://endpoint-trial.cognigy.ai";

		if (!endpointBaseUrl) {
			throw new Error("Unable to load webchat since the correct environment variables are missing");
		}

		/*
			The URL will look like:

			webchat-dev.cognigy.com/v2/39bb9cf78a54827d4cffa7e17ca26c5e9e52a327ce2c37398e5e66b26bf24ca7

			We need to extract the "token" which is the last part of the URL and looks like:
			'39bb9cf78a54827d4cffa7e17ca26c5e9e52a327ce2c37398e5e66b26bf24ca7'
		
		*/

		
		var token = "60eae51bdc5831ec80d0abf64376bf0c6abc82aa6ef94c2672f05c26f2b0cfaa";

		var endpointConfigUrl = endpointBaseUrl + '/' + token;

		var pluginUrls = [];

		fetchConfig(endpointConfigUrl, function (err, config) {
			if (err)
				return;

			var settings = config.settings;
			var body = document.getElementsByTagName('body')[0];

			// set background image
			if (settings.backgroundImageUrl) {
				body.style.backgroundSize = 'cover';
				body.style.backgroundPosition = 'center center';
				body.style.backgroundImage = 'url("' + settings.backgroundImageUrl + '")';
			}

			var isCenterWebchatLayout = settings.designTemplate === 2;

			// center webchat
			if (isCenterWebchatLayout) {
				body.classList.add('center-webchat');
			} else {
				// button toggle
				body.classList.add('bottom-webchat');
			}

			if (settings.enableSTT) {
				pluginUrls.push('/build/speech-input.webchat-plugin.legacy.js');
			}

			if (settings.enableTTS) {
				pluginUrls.push('/build/speech-output.webchat-plugin.legacy.js');
			}

			if (settings.pluginUrls) {
				pluginUrls = pluginUrls.concat(settings.pluginUrls)
			}

			loadScripts(pluginUrls, function () {
				initWebchat("https://endpoint-trial.cognigy.ai/60eae51bdc5831ec80d0abf64376bf0c6abc82aa6ef94c2672f05c26f2b0cfaa") {
					window.cognigyWebchat = webchat;

					if (isCenterWebchatLayout) {
						webchat.open();
					}
				});
			});
		});
	</script>
</body>
